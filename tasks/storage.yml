- name: Create the boot partition
  parted:
    device: "{{ disk.main }}"
    label: gpt
    number: 1
    state: present
    part_end: 30MiB
    flags:
      - boot
  tags:
    - storage

- name: Shred the boot partition

- name: Format the boot partition
  filesystem:
    fstype: ext2
    dev: "{{ disk.main }}1"

- name: Create the main partition
  parted:
    device: "{{ disk.main }}"
    number: 2
    state: present
    part_end: "{{ disk.main_size }}"
  tags:
    - storage

- name: Shred the main partition

- name: Format the main partition
  filesystem:
    fstype: ext4
    dev: "{{ disk.main }}2"
#- name: Create Grub BIOS Partition
#  command: "parted -s {{ main_disk }} -- mkpart primary ext2 1 100"
#  when: parted_is_done.stat.exists == False
#  tags:
#    - storage
#
#- name: Set Grub BIOS
#  command: "parted -s {{ main_disk }} -- set 1 bios_grub on"
#  when: parted_is_done.stat.exists == False
#  tags:
#    - storage
#
#- name: Create Boot Partition
#  command: "parted -s {{ main_disk }} -- mkpart primary {{ fstype }} 101 613"
#  when: parted_is_done.stat.exists == False
#  tags:
  #    - storage

- name: Format Boot Partition
  filesystem: "fstype={{ fstype }} dev={{ main_disk }}2 force={{ force_format }}"
  tags:
    - storage

- name: Create Main Physical Disk
  command: "parted -s {{ main_disk }} -- mkpart primary {{ fstype }} 614 -1"
  when: parted_is_done.stat.exists == False
  tags:
    - storage

- command: touch /tmp/parted_is_done

- name: Create Main Volume Group
  lvg: "pvs={{ main_disk }}3 vg=main"
  tags:
    - storage

- name: Create Swap Volume
  lvol: "lv=swap vg=main size={{ swap_size }}"
  tags:
    - storage

- name: Rescan Volumes
  command: vgscan

- name: Update device mapper
  command: vgchange -ay

- name: Format Swap Volume
  command: "mkswap /dev/mapper/main-swap"

- name: Create root Volume
  lvol: lv=root vg=main size=100%FREE
  tags:
    - storage

- name: Format root Volume
  filesystem: "fstype={{ fstype }} dev=/dev/mapper/main-root force={{ force_format }}"

- name: create root mount
  command: "{{item}} creates=/tmp/gentoo_mounted"
  with_items:
      - mkdir -p /mnt/gentoo
      - mount /dev/mapper/main-root /mnt/gentoo
      - touch /tmp/gentoo_mounted
  tags:
    - storage

- name: create boot mount
  command: "{{item}} creates=/tmp/boot_mounted"
  with_items:
      - mkdir -p /mnt/gentoo/boot
      - mount {{ main_disk }}2 /mnt/gentoo/boot
      - touch /tmp/boot_mounted
  tags:
    - storage
